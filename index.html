<html>
<script src="https://unpkg.com/web-audio-daw"></script>
  <!--<script src="wad.js"></script>-->
2f]i  
<script>
  var amen;
  var amenchops = [];
  var sprites = {};
  var iterator;
  var running = false;
  var notset = true;
  var easing_range;
  var valhist = [0,0,0,0,0];
  var maxval = 1;
  var sensor;

  Wad.logs.verbosity = 2;

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function make_amen() {
    for (var i = 1; i < 17; ++i) {
      amenchops[amenchops.length] = new Wad({source: `amen${i}.wav`});
    }
  }

  function figureOutWhichSlice(count) {
    var intensity = 0;
    var histmod = 0;
    
    if(valhist[0] > maxval) {
      document.getElementById("loggery").innerHTML = "fuckery!!<br/>" + document.getElementById("loggery").innerHTML;
    }
    
    for(var i = 0; i < valhist.length; ++i) {
      maxval = Math.max(valhist[i], maxval);
      histmod = histmod + valhist[i] * 1/5;
    }
    
    intensity = Math.floor(histmod / maxval);
    maxval = maxval * .95;
    result = Math.abs(Math.floor(count % 4 + intensity * 4) % 16);

    document.getElementById("valhists").innerHTML = 
      (`<br />${valhist[0]}, <br />${valhist[1]}, <br />${valhist[2]}, <br />${valhist[3]}, <br />${valhist[4]}` 
       + "<br />count: " + count + " \nintensity: " + intensity + "\n: " + "\n result: " + result);
  
    return result;
  }

  function start_linacc_modulation() {
    if(!sensor) {
      try {
        sensor = new LinearAccelerationSensor({frequency: 50});
        sensor.addEventListener('reading', () => {
          valhist = [Math.hypot(sensor.x, sensor.y, sensor.z), valhist[0], valhist[1], valhist[2], valhist[3]];
          document.getElementById("loggery").innerHTML = (`<br />${sensor.x}, <br />${sensor.y}, <br />${sensor.z}`);
        });
        sensor.start()
      }
      catch {
        alert("no linear acceleration sensor w/o frequency hint");
        var func;
        func = function() { 
          valhist = [document.getElementById("intensity"), valhist[0], valhist[1], valhist[2], valhist[3]];
          setTimeout(50, func);
        };
        func();
      }
    }
  }

  function play_amen() {
    running = true;
    var delay;
    var count = 0;
    var recursefunc;
    recursefunc = function() {
      if (running) {
        delay = document.getElementById("rate").value;
        count = count + 1;
        var which = figureOutWhichSlice(count);
        if (amenchops[which]) {
          amenchops[which].play();
          setTimeout(recursefunc, delay);
        } else { alert("whoops again! " + which) }
      }
    };

    if (notset || !running) {
      setTimeout(recursefunc, delay);
      notset = false;
    }
  }
</script>
<body>
  aaaaa >:c <br />
  <button onclick="make_amen()">make amen!</button> <br/>
  <button onclick="play_amen()">play amen!</button> <br/>
  <button onclick="start_linacc_modulation()">start accel mod!</button> <br/>
  <input id="rate" type="text" value="333"></input> milliseconds <br/>
  <input id="intensity" type="range" max="11" value="0"></input> &lt;- debug <br />
  <!--input id="intensity" type="text" value="0"></input> &lt;- 0,1,2,3 <br/-->
  <p id="loggery"></p> <br/>
  <p id="valhists"></p> <br/>
</body>
</html>
